name: Pre Release

on:
  push:
    branches:
      - pre

permissions:
  contents: write

env:
  TAG: ${{ github.sha }}
  Identity: ''
  BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
  NEW_VERSION: 'x.x.x'
  TEAM_ID: ''
  CERT_ID: ''
  ED_SIGNATURE: ''
  FILE_SIZE: ''
  DMG_FILENAME: ''
  VERSION: ''
  DMG_FILE: ''
  APP_PATH: ''

jobs:
  bump:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: æ›´æ–°ç‰ˆæœ¬å·
        run: |
          # è¯»å–å½“å‰ç‰ˆæœ¬å·
          VERSION=$(grep "version:" pubspec.yaml | sed 's/version: //' | tr -d "'")
          # åˆ†å‰²ç‰ˆæœ¬å·
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          # å¢åŠ è¡¥ä¸ç‰ˆæœ¬å·
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          # æ›´æ–° pubspec.yaml ä¸­çš„ç‰ˆæœ¬å·
          sed -i '' "s/version: .*/version: $NEW_VERSION/" pubspec.yaml
          echo "TAG=$NEW_VERSION" >> $GITHUB_ENV
      - name: æ‰“æ ‡ç­¾å¹¶æ¨é€åˆ°ä»“åº“
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'ğŸ¨ Bump version to ${{ env.TAG }}'
          commit_user_name: GitHub Action
          tagging_message: ${{ env.TAG }}

  rebase:
    needs:
      - bump
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å– dev åˆ†æ”¯
        uses: actions/checkout@v3
        with:
          ref: dev
      - name: æ‹‰å– pre åˆ†æ”¯
        run: git fetch origin pre
      - name: Rebase dev on pre
        continue-on-error: true
        run: git rebase origin/pre
      - name: Push the rebased dev branch
        continue-on-error: true
        run: git push origin dev

  build_with_signing:
    needs:
      - bump
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: pre
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      # https://docs.github.com/zh/actions/deployment/deploying-xcode-applications/installing-an-apple-certificate-on-macos-runners-for-xcode-development
      - name: Install the Apple certificate and provisioning profile
        env:
          P12_PASSWORD: ${{ secrets.BUILD_CERTIFICATE_P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64_GITOK_MACOS }}
          KEYCHAIN_PASSWORD: 'xxx'
        run: |
          # create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.provisionprofile
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # import certificate and provisioning profile from secrets
          echo -n "${{ env.BUILD_CERTIFICATE_BASE64 }}" | base64 --decode -o $CERTIFICATE_PATH
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

          # create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # import certificate to keychain
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # apply provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles
      - name: ç”Ÿæˆ App Store Connect API çš„ AuthKey
        run: |
          mkdir -p ./private_keys
          echo -n "${{ secrets.APP_STORE_CONNECT_KEY_BASE64 }}" | base64 --decode -o ./private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8
      - name: Get Certificate Info
        run: |
          # è·å–è¯ä¹¦ä¿¡æ¯å¹¶è§£æ
          CERT_INFO=$(security find-identity -v -p codesigning | grep '^[[:space:]]*1)' | head -n 1)
          CERT_ID=$(echo "$CERT_INFO" | awk -F'"' '{print $2}')
          TEAM_ID=$(echo "$CERT_INFO" | grep -o '[A-Z0-9]\{10\}' | tail -n 1)
          echo "CERT_ID=$CERT_ID" >> $GITHUB_ENV
          echo "TEAM_ID=$TEAM_ID" >> $GITHUB_ENV

      - name: Configure Xcode project
        run: |
          # ä¿®æ”¹æ‰€æœ‰ç­¾åç›¸å…³çš„é…ç½®
          PBXPROJ="macos/Runner.xcodeproj/project.pbxproj"

          # æ›¿æ¢æ‰€æœ‰ Mac Development ä¸ºå®é™…çš„è¯ä¹¦ ID
          sed -i '' "s/\"Mac Development\"/\"${{ env.CERT_ID }}\"/g" $PBXPROJ

          # æ›¿æ¢æ‰€æœ‰ DEVELOPMENT_TEAM
          sed -i '' "s/DEVELOPMENT_TEAM = \".*\"/DEVELOPMENT_TEAM = \"${{ env.TEAM_ID }}\"/g" $PBXPROJ

          # è®¾ç½®æ‰‹åŠ¨ç­¾å
          sed -i '' 's/CODE_SIGN_STYLE = Automatic/CODE_SIGN_STYLE = Manual/g' $PBXPROJ

          # è®¾ç½® CODE_SIGN_IDENTITY
          sed -i '' "s/CODE_SIGN_IDENTITY = \".*\"/CODE_SIGN_IDENTITY = \"${{ env.CERT_ID }}\"/g" $PBXPROJ

          # è®¾ç½® Debug å’Œ Release é…ç½®çš„ç­¾åèº«ä»½
          sed -i '' "s/\"CODE_SIGN_IDENTITY[^\"]*\" = \".*\"/\"CODE_SIGN_IDENTITY[sdk=macosx*]\" = \"${{ env.CERT_ID }}\"/g" $PBXPROJ

          # æ¸…é™¤å¯èƒ½å­˜åœ¨çš„é…ç½®æ–‡ä»¶æŒ‡å®šå™¨
          sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = ".*"/PROVISIONING_PROFILE_SPECIFIER = ""/g' $PBXPROJ

      - name: Build macOS App
        run: flutter build macos --release
      - name: find identity
        run: |
          i=$(security find-identity -v -p codesigning | grep '^[[:space:]]*1)' | awk -F'[(|)]' '{print $3}')
          echo "Identity=$i" >> $GITHUB_ENV

      - name: è·å–åº”ç”¨ç¨‹åºè·¯å¾„å’Œåç§°
        run: |
          APP_PATH=$(find build/macos/Build/Products/Release/ -type d -name "*.app" | head -n 1)
          APP_NAME=$(basename $APP_PATH)
          echo "APP_PATH=$APP_PATH" >> $GITHUB_ENV
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV

          echo "APP_PATH=$APP_PATH"
          echo "APP_NAME=$APP_NAME"

      # Codesign sparkle
      - name: Codesign sparkle
        run: |
          codesign -f -s ${{ env.Identity }} -o runtime ${{ env.APP_PATH }}/Contents/Frameworks/Sparkle.framework/Versions/B/XPCServices/Installer.xpc
          codesign -f -s ${{ env.Identity }} -o runtime --preserve-metadata=entitlements ${{ env.APP_PATH }}/Contents/Frameworks/Sparkle.framework/Versions/B/XPCServices/Downloader.xpc
          codesign -f -s ${{ env.Identity }} -o runtime ${{ env.APP_PATH }}/Contents/Frameworks/Sparkle.framework/Versions/B/Autoupdate
          codesign -f -s ${{ env.Identity }} -o runtime ${{ env.APP_PATH }}/Contents/Frameworks/Sparkle.framework/Versions/B/Updater.app
          codesign -f -s ${{ env.Identity }} -o runtime ${{ env.APP_PATH }}/Contents/Frameworks/Sparkle.framework

      # Codesign App
      - name: Codesign
        run: codesign --force -s ${{ env.Identity }} --option=runtime ${{ env.APP_PATH }}

      # Codesign Check
      - name: Codesign Check
        run: codesign -dv ${{ env.APP_PATH }}

      # Create DMG
      - name: Create DMG
        run: |
          # å®‰è£… create-dmg
          npm i -g create-dmg

          # åˆ›å»º DMG
          create-dmg ${{ env.APP_PATH }}

          # é‡å‘½å DMG æ–‡ä»¶ï¼ˆç§»é™¤ç©ºæ ¼ï¼‰
          for file in *.dmg; do
            mv "$file" "${file// /-}"
          done

      - name: ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
        run: chmod +x scripts/*.sh

      - name: è·å– DMG æ–‡ä»¶ä¿¡æ¯
        run: |
          # ä½¿ç”¨æˆ‘ä»¬çš„ DMG ä¿¡æ¯è·å–è„šæœ¬
          DMG_INFO=$(./scripts/get_dmg_info.sh .)

          # è§£æè„šæœ¬è¾“å‡ºå¹¶è®¾ç½®ç¯å¢ƒå˜é‡
          DMG_FILE=$(echo "$DMG_INFO" | grep "DMG_FILE=" | cut -d= -f2)
          DMG_FILENAME=$(echo "$DMG_INFO" | grep "DMG_FILENAME=" | cut -d= -f2)
          FILE_SIZE=$(echo "$DMG_INFO" | grep "FILE_SIZE=" | cut -d= -f2)

          # è®¾ç½® GitHub Actions ç¯å¢ƒå˜é‡
          echo "DMG_FILE=$DMG_FILE" >> $GITHUB_ENV
          echo "DMG_FILENAME=$DMG_FILENAME" >> $GITHUB_ENV
          echo "FILE_SIZE=$FILE_SIZE" >> $GITHUB_ENV

          echo "DMG æ–‡ä»¶ä¿¡æ¯ï¼š"
          echo "è·¯å¾„: $DMG_FILE"
          echo "æ–‡ä»¶å: $DMG_FILENAME"
          echo "å¤§å°: $FILE_SIZE å­—èŠ‚"

      - name: Notary
        continue-on-error: true
        run: |
          file=${{ env.DMG_FILE }}
          xcrun notarytool submit "$file" \
            --key ./private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 \
            --key-id=${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            --issuer ${{ secrets.APP_STORE_CONNECT_KEY_ISSER_ID }} \
            --wait \
            --timeout 10m
          stapler staple "$file"

          # å¦‚æœå‡ºç°é”™è¯¯ï¼ŒæŸ¥è¯¢æ—¥å¿—
          # xcrun notarytool log f66d58e3-d03a-4202-937e-5fca4e7cea83 
          #   --key ./private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 \
          #   --key-id ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
          #   --issuer ${{ secrets.APP_STORE_CONNECT_KEY_ISSER_ID }}
      - name: å…¬è¯ç»“æœ
        continue-on-error: true
        run: |
          file=${{ env.DMG_FILE }}
          stapler validate "$file"

      # è‡ªåŠ¨æ›´æ–°ç›¸å…³æ­¥éª¤
      - name: ä½¿ç”¨è„šæœ¬ç”Ÿæˆ Sparkle ç­¾å
        run: |
          # ä½¿ç”¨æˆ‘ä»¬çš„ç­¾åè„šæœ¬
          SIGNATURE_OUTPUT=$(echo "${{ secrets.SPARKLE_PRIVATE_KEY_GITOK }}" | ./scripts/sign_update.sh "${{ env.DMG_FILE }}")

          # æå–ç­¾åå€¼
          ED_SIGNATURE=$(echo "$SIGNATURE_OUTPUT" | grep -o 'sparkle:edSignature="[^"]*"')
          echo "ED_SIGNATURE=$ED_SIGNATURE" >> $GITHUB_ENV

      - name: ä½¿ç”¨è„šæœ¬ç”Ÿæˆ appcast.xml
        run: |
          # ä½¿ç”¨æˆ‘ä»¬çš„ appcast ç”Ÿæˆè„šæœ¬
          ./scripts/generate_appcast.sh "${{ env.DMG_FILE }}" "${{ env.TAG }}" "${{ env.ED_SIGNATURE }}"

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          prerelease: true
          files: |
            ./**/*.dmg
            ./appcast.xml
